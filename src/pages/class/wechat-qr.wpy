<template>
    <block wx:if="{{ready && !_error}}">
        <view class="wechat {{!detail.committee ? 'no-admin' : ''}}" wx:if="{{detail.isSupportAdd}}">
            <block wx:if="{{detail.qrCodeUrl}}">
                <text>你可以长按识别二维码加群</text>
                <image class="qrcode" src="{{detail.qrCodeUrl}}" @tap="viewQrCode"></image>
            </block>
            <block wx:if="{{detail.committee}}">
                <text wx:if="{{detail.qrCodeUrl}}">你也可添加班委微信号：{{detail.committee}}，请求加群</text>
                <text wx:else>你可添加班委微信号：{{detail.committee}}，请求加群</text>
            </block>
        </view>

        <form class="btn-box btn-save-image" report-submit="true" @submit="getFormId" wx:if="{{detail.qrCodeUrl}}">
            <button class="btn-primary" form-type="submit" @tap="saveImage">保存图片</button>
        </form>
    </block>
</template>

<style lang="less">
    @import (reference) "../../static/less/utility";

    page {
        background-color: #fff;
    }

    .wechat {
        margin-top: 50rpx;
        line-height: 100rpx;
        text-align: center;
        font-size: 28rpx;
        color: #aaa;

        & > text {
            display: block;
        }

        .qrcode {
            display: block;
            width: 290rpx;
            height: 290rpx;
            margin: 0 auto;
        }

        & + .btn-box {
            margin-top: 60rpx;
        }

        &.no-admin + .btn-box {
            margin-top: 80rpx;
        }
    }
</style>

<script>
    import wepy from "wepy";
    import ready from "../../mixins/ready";
    import formIds from "../../mixins/formIds";
    import boot from "../../mixins/boot";
    import classInfo from "../../mixins/classInfo";

    export default class extends wepy.page {
        config = {
            disableScroll: true,
            navigationBarTitleText: "查看班级群二维码"
        };

        data = {
            userInfo: {}
        };

        mixins = [ready, classInfo, formIds, boot];

        methods = {
            login (e) {
                wx.setStorageSync("token", {});

                this.$parent.getUserInfo((userInfo = {}) => {
                    this.userInfo = Object.assign({}, userInfo);
                    this.$apply();
                }, e.detail);
            },
            viewQrCode () {
                wx.previewImage({
                    urls: [this.detail.qrCodeUrl],
                    current: this.detail.qrCodeUrl
                });
            },
            saveImage (e) {
                wx.downloadFile({
                    url: this.detail.qrCodeUrl,
                    success: (res) => {
                        if (res.statusCode === 200) {
                            wx.saveImageToPhotosAlbum({
                                filePath: res.tempFilePath,
                                success () {
                                    wx.showToast({
                                        title: "保存成功",
                                        icon: "success"
                                    });
                                },
                                fail () {
                                    wx.showToast({
                                        title: "保存失败",
                                        icon: "fail"
                                    });
                                }
                            });
                        }
                    }
                });
            }
        };

        onShow() {
            this.$parent.getUserInfo((userInfo) => {
                this.userInfo = Object.assign({}, userInfo);
                this.addReadyCallback(this.getClassDetail());
                this.runReadyCallbacks();
            });
        }
    }
</script>